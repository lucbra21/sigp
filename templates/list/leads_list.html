{% extends 'layouts/base.html' %}
{% block title %}Gestión de leads{% endblock %}
{% block content %}
<h2>Gestión de leads</h2>
<a href="{{ url_for('leads.new_lead') }}" class="btn btn-primary mb-3 me-3">Nuevo lead</a>
<form method="get" class="row g-2 align-items-end mb-3">
  <div class="col-md-3">
    <label class="form-label">Candidato</label>
    <input type="text" name="candidate" value="{{ filters.candidate }}" class="form-control" placeholder="Nombre">
  </div>
  <div class="col-md-3">
    <label class="form-label">Prescriptor</label>
    <select name="prescriptor" class="form-select">
      <option value="">Todos</option>
      {% for pid, pname in presc_choices %}
      <option value="{{ pid }}" {% if filters.prescriptor==pid %}selected{% endif %}>{{ pname }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-3">
    <label class="form-label">Estado</label>
    <select name="state" class="form-select">
      <option value="">Todos</option>
      {% for sid, sname in state_choices %}
      <option value="{{ sid }}" {% if filters.state==sid|string %}selected{% endif %}>{{ sname }}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-md-2">
    <button type="submit" class="btn btn-secondary w-100">Filtrar</button>
  </div>
</form>
<table class="table table-bordered table-sm">
    <thead>
        <tr>
            <th>Fecha</th>
            <th>Candidato</th>
            <th>Prescriptor</th>
            <th>Celular</th>
            <th>Comercial</th>
            <th>Estado</th>
            {% if can('update_leads') or can('delete_leads') or can('view_leads') %}<th>Acciones</th>{% endif %}
        </tr>
    </thead>
    <tbody>
    {% for l in leads %}
        <tr>
            <td>{{ l.created_at.strftime('%d/%m/%Y') if l.created_at }} </td>
            <td>{{ l.candidate_name or '-' }}<br><small>{{ l.candidate_email }}</small></td>
            <td>{{ pres_map.get(l.prescriptor_id, l.prescriptor_id) }}</td>
            <td>{{ l.candidate_cellular or '-' }}</td>
            <td>{{ l.commercial_id or '-' }}</td>
            <td>{{ state_map.get(l.state_id, l.state_id) }}</td>
            {% if can('update_leads') or can('delete_leads') or can('view_leads') %}
            <td>
              {% if can('update_leads') %}
              <a href="{{ url_for('leads.edit_lead', lead_id=l.id) }}" class="btn btn-sm btn-secondary me-1">Editar</a>
              {% endif %}
              {% if can('view_leads') %}
              <a href="{{ url_for('leads.lead_history', lead_id=l.id) }}" class="btn btn-sm btn-info me-1">Histórico</a>
               <a href="{{ url_for('leads.update_status', lead_id=l.id) }}" class="btn btn-sm btn-warning me-1">Actualizar estado</a>
              {% endif %}
              {% if can('delete_leads') and l.state_id==6 %}
              <form method="post" action="{{ url_for('leads.delete_lead', lead_id=l.id) }}" class="d-inline" onsubmit="return confirm('¿Eliminar lead?');">
                <button type="submit" class="btn btn-sm btn-danger">Eliminar</button>
              </form>
              {% endif %}
            </td>
            {% endif %}
        </tr>
    {% endfor %}
    </tbody>
</table>
{% if total==0 %}<p>No hay leads.</p>{% endif %}
{% endblock %}
