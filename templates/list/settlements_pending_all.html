{% extends 'layouts/base.html' %}
{% block title %}Facturas pendientes de rendición{% endblock %}
{% block content %}
<div id="settPendLoading" class="position-fixed top-0 start-0 w-100 h-100 d-none justify-content-center align-items-center" style="background:rgba(255,255,255,.7);z-index:1050;">
  <img src="{{ url_for('static', filename='img/loader.gif') }}" alt="cargando...">
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="fw-semibold mb-0">Facturas pendientes de rendición</h2>
</div>

<div class="card shadow-sm mb-4 bg-light border border-secondary-subtle rounded">
  <div class="card-body">
    <form id="settPendFilterForm" class="row row-cols-lg-auto g-3 align-items-end" method="get" action="{{ url_for('settlements.pending_all') }}">
      <div class="col-md-4">
        <label class="form-label">Prescriptor</label>
        <select id="presc" class="form-select" name="prescriptor_id">
          <option value="">Todos</option>
          {% for p in prescriptors %}
          <option value="{{ p.id }}" {% if p.id|string == presc_sel|string %}selected{% endif %}>{{ (p|attr(label_attr)) if label_attr else p.id }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2">
        <label class="form-label">Desde</label>
        <input type="date" class="form-control" name="date_from" value="{{ date_from }}">
      </div>
      <div class="col-md-2">
        <label class="form-label">Hasta</label>
        <input type="date" class="form-control" name="date_to" value="{{ date_to }}">
      </div>
      <div class="col-md-2 pt-4">
        <button class="btn btn-primary btn-loading">Filtrar</button>
      </div>
      {% if presc_sel %}
      <div class="col-md-2 pt-4">
        <a class="btn btn-success w-100 btn-loading" href="{{ url_for('settlements.pending_invoices', prescriptor_id=presc_sel) }}">Rendir facturas</a>
      </div>
      {% endif %}
    </form>
  </div>
</div>

<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead>
        <tr><th>ID</th><th>Prescriptor</th><th>Fecha</th><th>Total</th></tr>
      </thead>
      <tbody>
        {% for inv in invoices %}
        <tr>
          <td>{{ inv.id }}</td>
          <td>{{ presc_map[inv.prescriptor_id] }}</td>
          <td>{{ inv.invoice_date }}</td>
          <td>{{ '%.2f'|format(inv.total) }} €</td>
        </tr>
        {% else %}
        <tr><td colspan="4" class="text-center">No hay facturas pendientes</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
<script>
  document.addEventListener('DOMContentLoaded',()=>{
    const ov=document.getElementById('settPendLoading');
    const show=()=>{ov && (ov.classList.remove('d-none'),ov.classList.add('d-flex'))};
    document.querySelectorAll('.btn-loading').forEach(b=>b.addEventListener('click',show));
    const f=document.getElementById('settPendFilterForm');
    if(f){f.addEventListener('submit',show);}  
  });
</script>


{% endblock %}
