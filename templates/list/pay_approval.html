{% extends 'layouts/base.html' %}
{% block title %}Aprobación de pagos{% endblock %}
{% block content %}
<h2>Aprobación de pagos</h2>
<form class="row g-2 mb-3" method="get">
  <div class="col-auto">
    <label class="form-label">Desde</label>
    <select class="form-select" name="from_month">
      {% for m in range(1,13) %}
      <option value="{{m}}" {% if m == from_month %}selected{% endif %}>{{'%02d' % m}}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto">
    <label class="form-label">Año</label>
    <input type="number" name="from_year" value="{{ from_year }}" class="form-control" />
  </div>
  <div class="col-auto">
    <label class="form-label">Hasta</label>
    <select class="form-select" name="to_month">
      {% for m in range(1,13) %}
      <option value="{{m}}" {% if m == to_month %}selected{% endif %}>{{'%02d' % m}}</option>
      {% endfor %}
    </select>
  </div>
  <div class="col-auto">
    <label class="form-label">Año</label>
    <input type="number" name="to_year" value="{{ to_year }}" class="form-control" />
  </div>
  <div class="col-auto align-self-end">
    <button class="btn btn-primary">Filtrar</button>
  </div>
</form>
<form method="post" action="{{ url_for('admin.bulk_approve') }}" id="bulkForm">
  <div class="mb-2">
    <button type="button" class="btn btn-sm btn-secondary" id="selAll">Seleccionar todos</button>
    <button type="button" class="btn btn-sm btn-secondary" id="deselAll">Deseleccionar todos</button>
    <button type="submit" class="btn btn-sm btn-success" onclick="return confirm('¿Aprobar movimientos seleccionados?');">Aprobar seleccionados</button>
  </div>
<table class="table table-striped">
  <thead>
    <tr>
      <th><input type="checkbox" id="headerChk" /></th>
      <th>Prescriptor</th>
      <th>Lead</th>
      <th>Concepto</th>
      <th>Monto</th>
      <th>Periodo</th>
      <th>Acciones</th>
    </tr>
      <th>Prescriptor</th>
  </thead>
  <tbody>
  {% for r in rows %}
    <tr>
      <td><input type="checkbox" class="rowchk" name="selected_ids" value="{{ r.id }}" /></td>
      <td>{{ pres_map.get(r.prescriptor_id, r.prescriptor_id) }}</td>
      <td>{{ lead_map.get(r.lead_id, '-') }}</td>
      <td>{{ r.concept }}</td>
      <td>{{ '%.2f'|format(r.amount) }}</td>
      <td>{{ r.approve_due_month }}/{{ r.approve_due_year }}</td>
      <td>
        <form method="post" action="{{ url_for('admin.approve_payment', ledger_id=r.id) }}" class="d-inline">
          <button class="btn btn-sm btn-success" onclick="return confirm('¿Aprobar?');">Aprobar</button>
        </form>
        <form method="post" action="{{ url_for('admin.reject_payment', ledger_id=r.id) }}" class="d-inline">
          <button class="btn btn-sm btn-danger" onclick="return confirm('¿Anular?');">Anular</button>
        </form>
      </td>
    </tr>
  {% endfor %}
  </tbody>
</table>
</form>
<script>
  document.getElementById('selAll').addEventListener('click', () => {
    document.querySelectorAll('.rowchk').forEach(cb => cb.checked = true);
  });
  document.getElementById('deselAll').addEventListener('click', () => {
    document.querySelectorAll('.rowchk').forEach(cb => cb.checked = false);
  });
  document.getElementById('headerChk').addEventListener('change', (e) => {
    document.querySelectorAll('.rowchk').forEach(cb => cb.checked = e.target.checked);
  });
</script>
{% if rows|length == 0 %}<p>No hay pagos pendientes.</p>{% endif %}
{% endblock %}
