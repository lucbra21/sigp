{% extends 'layouts/base.html' %}
{% block title %}Estados de lead{% endblock %}
{% block content %}
<!-- Loading overlay -->
<div id="stateLeadsFilterLoading" class="position-fixed top-0 start-0 w-100 h-100 d-none justify-content-center align-items-center" style="background:rgba(255,255,255,.7);z-index:1050;">
  <img src="{{ url_for('static', filename='img/loader.gif') }}" alt="cargando...">
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="fw-semibold">Gestión de Estados de Leads</h2>
  {% if can('create_state_lead') %}
  <a href="{{ url_for('state_lead.state_lead_new') }}" id="btnNuevo" class="btn btn-success">Agregar nuevo</a>
  {% endif %}
</div>

<!-- Filtros -->
<div class="card shadow-sm mb-4 bg-light border border-secondary-subtle rounded">
  <div class="card-body">
    <form id="stateLeadsFilterForm" class="row row-cols-lg-auto g-3 align-items-end" method="get">
      <div class="col-12">
        <input type="text" name="q" class="form-control" placeholder="Filtrar por nombre" value="{{ q }}" />
      </div>
      {% if colors_available %}
      <div class="col-12">
        <select name="color" class="form-select">
          <option value="">Todos los colores</option>
          {% for c in colors_available %}
          <option value="{{ c }}" {% if color_filter==c %}selected{% endif %}>{{ c }}</option>
          {% endfor %}
        </select>
      </div>
      {% endif %}
      <div class="col-12">
        <button type="submit" class="btn btn-primary">Filtrar</button>
      </div>
    </form>
  </div>
</div>

<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nombre</th>
          <th>Descripción</th>
          <th>Color</th>
          <th>Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for l in leads %}
        <tr>
          <td>{{ l.id }}</td>
          <td>{{ l.name }}</td>
          <td>{{ l.description|default('') }}</td>
          <td>
            {% set col = l.color|default('') %}
            {% if col %}
            <span class="badge" style="background: {{ col }};">&nbsp;</span>
            <small>{{ col }}</small>
            {% endif %}
          </td>
          <td>
            {% if can('update_state_lead') %}
            <a href="{{ url_for('state_lead.state_lead_edit', lead_id=l.id) }}" class="btn btn-sm btn-primary">Editar</a>
            {% endif %}
            {% if can('delete_state_lead') %}
            <form method="post" action="{{ url_for('state_lead.state_lead_delete', lead_id=l.id) }}" class="d-inline">
              <button type="submit" class="btn btn-sm btn-danger" data-confirm="¿Eliminar estado?">Borrar</button>
            </form>
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<nav class="d-flex justify-content-center mt-4">
  <ul class="pagination pagination-sm pagination-glass mb-0">
    {% for p in range(1, pages + 1) %}
    <li class="page-item {% if p == page %}active{% endif %}">
      <a class="page-link" href="?q={{ q }}{% if color_filter %}&color={{ color_filter }}{% endif %}&page={{ p }}">{{ p }}</a>
    </li>
    {% endfor %}
  </ul>
</nav>

<style>
.pagination-glass .page-link{
  background: rgba(255,255,255,0.8);
  backdrop-filter: blur(6px);
  -webkit-backdrop-filter: blur(6px);
  border: 1px solid rgba(0,0,0,.1);
  border-radius: 30px;
  color:#333;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
  transition:all .2s;
}
.pagination-glass .page-link:hover{
  background: rgba(0,86,210,0.1);
  color:#0056d2;
}
.pagination-glass .page-item.active .page-link{
  background:#0056d2;
  color:#fff;
  border-color:#0056d2;
}
.pagination-glass .page-item.disabled .page-link{
  opacity:.5;
  pointer-events:none;
}
</style>

<script>
  document.addEventListener('DOMContentLoaded', function(){
    const ov = document.getElementById('stateLeadsFilterLoading');
    function show(){ov.classList.remove('d-none');ov.classList.add('d-flex');}

    const f = document.getElementById('stateLeadsFilterForm');
    if(f){f.addEventListener('submit', show);}    

    const btnNuevo = document.getElementById('btnNuevo');
    if(btnNuevo){btnNuevo.addEventListener('click', show);}   

    // enlaces editar dentro de la tabla
    document.querySelectorAll('a.btn-primary').forEach(a=>a.addEventListener('click', show));
  });
</script>

{% endblock %}
