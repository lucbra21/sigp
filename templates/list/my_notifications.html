{% extends 'layouts/base.html' %}
{% block title %}Mis notificaciones{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0"><i class="bi bi-bell me-1"></i> Mis notificaciones</h2>
  <span class="badge bg-primary">{{ notifs|length }}</span>
</div>

<div class="card shadow-sm mb-4 bg-light border border-secondary-subtle rounded">
  <div class="card-body">
    <form id="notifFilterForm" class="row row-cols-lg-auto g-3 align-items-end" method="get" action="{{ url_for('notifications.my_notifications') }}">
      <select name="status" class="form-select w-auto d-inline-block">
          <option value="all" {% if status=='all' %}selected{% endif %}>Todas</option>
          <option value="unread" {% if status=='unread' %}selected{% endif %}>No leídas</option>
          <option value="read" {% if status=='read' %}selected{% endif %}>Leídas</option>
      </select>
      <div class="col-auto">
        <button type="submit" class="btn btn-primary">Filtrar</button>
      </div>
    
  </form>
  </div>
</div>


<div class="text-end mb-3">
  <form id="markAllForm" method="get" action="{{ url_for('notifications.mark_all_read') }}" class="d-inline">
  <button class="btn btn-outline-success btn-sm" {% if not notifs %}disabled{% endif %} title="Marcar todas como leídas"><i class="bi bi-check2-all"></i> Todas leídas</button>
</form>
</div>
<div class="list-group">
    {% for n in notifs %}
    <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-start {% if not n.is_read %}list-group-item-warning{% endif %}">
      <div class="ms-2 me-auto">
        <div class="fw-semibold">
          <a href="{{ n.link_url }}" target="_blank" class="text-decoration-none">{{ n.title }}</a>
          {% if not n.is_read %}<span class="badge rounded-pill bg-danger ms-2">Nuevo</span>{% endif %}
        </div>
        <small class="text-muted">{{ n.created_at.strftime('%d/%m/%Y %H:%M') }}</small>
        <p class="mb-1 small">{{ n.body }}</p>
      </div>
      {% if n.is_read %}
        <a href="{{ url_for('notifications.mark_unread', notif_id=n.id) }}" class="btn btn-outline-secondary btn-sm" title="Marcar como no leída"><i class="bi bi-envelope"></i></a>
      {% else %}
        <a href="{{ url_for('notifications.mark_read', notif_id=n.id) }}" class="btn btn-outline-success btn-sm" title="Marcar como leída"><i class="bi bi-envelope-open"></i></a>
      {% endif %}
    </div>
{% endfor %}
</div>

<nav aria-label="Paginación" class="mt-3">
  <ul class="pagination justify-content-center">
    <li class="page-item {% if page==1 %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('notifications.my_notifications', page=page-1 if page>1 else 1, status=status) }}" aria-label="Anterior">
        <span aria-hidden="true">&laquo;</span>
      </a>
    </li>
    {% for p in range(1, pages+1) %}
      <li class="page-item {% if p==page %}active{% endif %}">
        <a class="page-link" href="{{ url_for('notifications.my_notifications', page=p, status=status) }}">{{ p }}</a>
      </li>
    {% endfor %}
    <li class="page-item {% if page==pages %}disabled{% endif %}">
      <a class="page-link" href="{{ url_for('notifications.my_notifications', page=page+1 if page<pages else pages, status=status) }}" aria-label="Siguiente">
        <span aria-hidden="true">&raquo;</span>
      </a>
    </li>
  </ul>
</nav>
<!-- Loading overlay -->
<div id="myNotifLoading" class="position-fixed top-0 start-0 w-100 h-100 d-none justify-content-center align-items-center" style="background:rgba(255,255,255,.7);z-index:1050;">
  <img src="{{ url_for('static', filename='img/loader.gif') }}" alt="cargando...">
</div>
<script>
  document.addEventListener('DOMContentLoaded',()=>{
    const ov=document.getElementById('myNotifLoading');
    const show=()=>{ov.classList.remove('d-none');ov.classList.add('d-flex');};
    // botones marcar leída / no leída
    document.querySelectorAll('a[href*="/notifications/mark-read"], a[href*="/notifications/mark-unread"]').forEach(el=>{
      el.addEventListener('click',show);
    });
    // formulario filtrar
    const filt=document.getElementById('notifFilterForm');
    if(filt){filt.addEventListener('submit',show);}  
    // formulario marcar todas como leídas
    const markAll=document.getElementById('markAllForm');
    if(markAll){markAll.addEventListener('submit',show);}  
  });
</script>
{% endblock %}
