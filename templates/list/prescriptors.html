{% extends 'layouts/base.html' %}
{% block title %}Listado de Prescriptores{% endblock %}
{% block content %}
<!-- Loading overlay -->
<div id="prescriptorsLoading" class="position-fixed top-0 start-0 w-100 h-100 d-none justify-content-center align-items-center" style="background:rgba(255,255,255,.7);z-index:1050;">
  <img src="{{ url_for('static', filename='img/loader.gif') }}" alt="cargando...">
</div>
<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="fw-semibold mb-0">Prescriptores</h2>
    <a href="{{ url_for('prescriptors.new_prescriptor') }}" id="btnNuevo" class="btn btn-primary">Nuevo Prescriptor</a>
</div>


<!-- Filtros -->
<div class="card filter-card p-3 mb-4">
<form class="row row-cols-lg-auto g-2 align-items-end" method="get" id="filterForm">
    <div class="col-12">
        <label for="fNombre" class="form-label">Nombre</label>
        <input type="text" class="form-control" id="fNombre" name="nombre" value="{{ filters.nombre }}">
    </div>
    <div class="col-12">
        <label for="fTipo" class="form-label">Tipo</label>
        <select id="fTipo" name="tipo" class="form-select">
            <option value="">- Todos -</option>
            {% for val, lbl in type_choices %}
            <option value="{{ val }}" {% if filters.tipo==val %}selected{% endif %}>{{ lbl }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-12">
        <label for="fEstado" class="form-label">Estado</label>
        <select id="fEstado" name="estado" class="form-select">
            <option value="">- Todos -</option>
            {% for val, lbl in state_choices %}
            <option value="{{ val }}" {% if filters.estado==val %}selected{% endif %}>{{ lbl }}</option>
            {% endfor %}
        </select>
    </div>
    <div class="col-12">
        <button type="submit" class="btn btn-secondary">Filtrar</button>
    </div>
</form>
</div>
<div class="card table-card p-0 mb-4"><table class="table table-hover align-middle mb-0">
    <thead>
        <tr>
            <th>Nombre</th>
            <th>Tipo</th>
            <th>Sub&nbsp;Estado</th>
            <th>Nivel confianza</th>
            <th>Estado squeeze</th>
            <th>Acciones</th>
        </tr>
    </thead>
    <tbody>
        {% for p in items %}
        <tr>
            <td>{{ p.nombre }}</td>
            <td>{{ p.tipo }}</td>
            <td>{{ p.sub_state_name }}</td>
            <td>{{ p.confidence_name }}</td>
            <td>{{ p.squeeze_page_status }}</td>
            <td>
                <a href="{{ url_for('prescriptors.edit_prescriptor', prescriptor_id=p.id) }}" class="btn btn-sm btn-secondary">Editar</a>
                {% if can('update_prescriptor_commission') %}
                <a href="{{ url_for('prescriptors.prescriptor_commissions', prescriptor_id=p.id) }}" class="btn btn-sm btn-warning">Comisiones</a>
                {% endif %}
                <a href="{{ url_for('landing.landing_page', prescriptor_id=p.id) }}" target="_blank" class="btn btn-sm btn-info">Squeeze Page</a>
            </td>
        </tr>
        {% endfor %}
    </tbody>
</table></div>

{% set pages = (total // per_page) + (1 if (total % per_page) > 0 else 0) %}
<!-- PaginaciÃ³n -->
<nav class="d-flex justify-content-center mt-4" aria-label="Page navigation">
    <ul class="pagination pagination-sm pagination-glass mb-0">
        {% for p in range(1, pages + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}"><a class="page-link" href="?nombre={{ filters.nombre }}&tipo={{ filters.tipo }}&estado={{ filters.estado }}&page={{ p }}">{{ p }}</a></li>
        {% endfor %}
    </ul>
</nav>

<script>
  document.addEventListener('DOMContentLoaded',()=>{
    const ov=document.getElementById('prescriptorsLoading');
    function show(){ov.classList.remove('d-none');ov.classList.add('d-flex');}
    const filter=document.getElementById('filterForm');
    if(filter){filter.addEventListener('submit',show);}    
    const btnNuevo=document.getElementById('btnNuevo');
    if(btnNuevo){btnNuevo.addEventListener('click',show);}    
    document.querySelectorAll('.pagination a.page-link').forEach(a=>a.addEventListener('click',show));
    // Editar y Comisiones
    document.querySelectorAll('a.btn-secondary, a.btn-warning').forEach(a=>a.addEventListener('click',show));
  });
</script>
{% endblock %}
