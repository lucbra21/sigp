{% extends 'layouts/base.html' %}
{% block title %}Rendición de facturas{% endblock %}
{% block content %}
<div id="settlementsLoading" class="position-fixed top-0 start-0 w-100 h-100 d-none justify-content-center align-items-center" style="background:rgba(255,255,255,.7);z-index:1050;">
  <img src="{{ url_for('static', filename='img/loader.gif') }}" alt="cargando...">
</div>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h2 class="fw-semibold mb-0">Rendición de Facturas</h2>
</div>

<!-- Filtro y acciones -->
<div class="card shadow-sm mb-4 bg-light border border-secondary-subtle rounded">
  <div class="card-body">
    <form id="settlementsFilterForm" method="get" class="row row-cols-lg-auto g-3 align-items-end">
      <div class="col-md-4">
        <label class="form-label">Prescriptor</label>
        <select name="prescriptor" class="form-select">
          <option value="">Todos</option>
          {% for pid,name in prescriptors %}
          <option value="{{ pid }}" {% if pid|string == presc_sel %}selected{% endif %}>{{ name }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="col-md-2 pt-4">
        <button type="submit" class="btn btn-primary btn-loading">Filtrar</button>
      </div>
      <div class="col-md-3 pt-4">
        <a href="#" class="btn btn-success w-100 btn-loading" id="genBtn" target="_blank">Generar rendición</a>
      </div>
    </form>
  </div>
</div>

<form method="post" id="settlementsForm" enctype="multipart/form-data">
  <div class="card shadow-sm">
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead><tr>
          {% if presc_sel %}<th style="width:40px;"></th>{% endif %}
          <th>Prescriptor</th><th>Número</th><th>Fecha</th><th>Total</th><th>Monto rendido</th><th>Comprobante</th>
        </tr></thead>
        <tbody>
          {% for inv in invoices %}
          <tr>
            {% if presc_sel %}<td><input type="checkbox" name="selected_ids" value="{{ inv.id }}" class="form-check-input"/></td>{% endif %}
            <td>{{ presc_map.get(inv.prescriptor_id, inv.prescriptor_id) }}</td>
            <td>{{ inv.number }}</td>
            <td>{{ inv.invoice_date }}</td>
            <td>{{ '%.2f'|format(inv.total) }} €</td>
            <td><input type="number" name="amount_{{ inv.id }}" class="form-control form-control-sm" step="0.01" value="{{ '%.2f'|format(inv.total) }}"></td>
            <td><input type="file" name="file_{{ inv.id }}" class="form-control form-control-sm"/></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
  {% if presc_sel %}
  <div class="mt-3 text-end">
    <button type="submit" formaction="{{ url_for('admin.settlements_save') }}" class="btn btn-success btn-loading" data-confirm="¿Guardar rendición?">Guardar rendición</button>
  </div>
  {% endif %}
  {% if invoices|length == 0 %}<p class="mt-3">No hay facturas pendientes de rendición.</p>{% endif %}
</form>

<script>
  document.addEventListener('DOMContentLoaded',()=>{
    const ov=document.getElementById('settlementsLoading');
    const show=()=>{ov && (ov.classList.remove('d-none'),ov.classList.add('d-flex'))};
    document.querySelectorAll('.btn-loading').forEach(b=>b.addEventListener('click',show));
    const filter=document.getElementById('settlementsFilterForm');
    if(filter){filter.addEventListener('submit',show);}    

    // gen rendicion link
    const genBtn=document.getElementById('genBtn');
    if(genBtn){genBtn.addEventListener('click',e=>{
      const sel=document.querySelector('select[name=prescriptor]').value;
      if(!sel){e.preventDefault();Swal.fire('Selecciona un prescriptor');return;}
      genBtn.href='{{ url_for('admin.settlements_form') }}?prescriptor='+sel;
    });}
  });
</script>


  <div class="col-md-4">
    <label class="form-label">Prescriptor</label>
    <select name="prescriptor" class="form-select">
      <option value="">Todos</option>
      {% for pid,name in prescriptors %}
      <option value="{{ pid }}" {% if pid|string == presc_sel %}selected{% endif %}>{{ name }}</option>
      {% endfor %}
    </select>
  </div>
<div class="col-md-2 align-self-end">
  <button type="submit" class="btn btn-secondary w-100">Filtrar</button>
</div>
<div class="col-md-2 align-self-end">
  <a href="#" class="btn btn-primary w-100" id="genBtn" target="_blank">Generar rendición</a>
</div>
</form>
<form method="post" action="{{ url_for('admin.settlements_save') }}" enctype="multipart/form-data">


  <thead>
    <tr>
      {% if presc_sel %}<th></th>{% endif %}
      <th>Prescriptor</th>
      <th>Número</th>
      <th>Fecha</th>
      <th>Total</th>
      <th>Monto rendido</th>
      <th>Comprobante</th>
    </tr>
  </thead>
  <tbody>
    {% for inv in invoices %}
    <tr>
      {% if presc_sel %}<td><input type="checkbox" name="selected_ids" value="{{ inv.id }}"/></td>{% endif %}
      <td>{{ presc_map.get(inv.prescriptor_id, inv.prescriptor_id) }}</td>
      <td>{{ inv.number }}</td>
      <td>{{ inv.invoice_date }}</td>
      <td>{{ '%.2f'|format(inv.total) }} €</td>
      <td><input type="number" name="amount_{{ inv.id }}" class="form-control form-control-sm" step="0.01" value="{{ '%.2f'|format(inv.total) }}"></td>
      <td>
        <input type="file" name="file_{{ inv.id }}" class="form-control form-control-sm"/>
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>
{% if presc_sel %}
<div class="mt-2">
  <button type="submit" class="btn btn-success" onclick="return confirm('¿Guardar rendición?');">Guardar rendición</button>
</div>
{% endif %}
{% if invoices|length == 0 %}<p>No hay facturas pendientes de rendición.</p>{% endif %}
</form>
<script>
  ('click',()=>{
    document.querySelectorAll('.rowchk').forEach(cb=>cb.checked=true);
  });
  ('click',()=>{
    document.querySelectorAll('.rowchk').forEach(cb=>cb.checked=false);
  });
  ('change',e=>{
    document.querySelectorAll('.rowchk').forEach(cb=>cb.checked=e.target.checked);
  });
// button logic
  document.getElementById('genBtn').addEventListener('click',function(e){
    const sel=document.querySelector('select[name=prescriptor]').value;
    if(!sel){e.preventDefault();alert('Selecciona un prescriptor');return;}
    this.href='{{ url_for('admin.settlements_form') }}?prescriptor='+sel;
  });
</script>
{% endblock %}
