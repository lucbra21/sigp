{% extends 'layouts/base.html' %}
{% block title %}Reporte de Prescriptor{% endblock %}
{% block content %}
<div class="container py-4">
  <h3>Dashboard de Prescriptor</h3>
  <form class="row row-cols-lg-auto g-2 align-items-end mb-3" method="get" action="{{ url_for('dashboard.prescriptor_report') }}">
    <div class="col-12">
      <label class="form-label">Prescriptor</label>
      <select class="form-select" name="prescriptor_id" {% if prescriptor_locked %}disabled{% endif %}>
        <option value="">-- Todos --</option>
        {% for p in prescriptors %}
        <option value="{{ p.id }}" {% if p.id|string == presc_sel|string %}selected{% endif %}>{{ (p|attr(label_attr)) if label_attr else p.id }}</option>
        {% endfor %}
      </select>
      {% if prescriptor_locked %}
      <input type="hidden" name="prescriptor_id" value="{{ presc_sel }}">
      {% endif %}
    </div>
    <div class="col-12">
      <label class="form-label">Desde</label>
      <input type="date" class="form-control" name="date_from" value="{{ date_from }}">
    </div>
    <div class="col-12">
      <label class="form-label">Hasta</label>
      <input type="date" class="form-control" name="date_to" value="{{ date_to }}">
    </div>
    <div class="col-12">
      <button class="btn btn-outline-secondary">Filtrar</button>
    </div>
  </form>

  <table class="table table-bordered w-auto">
    <tbody>
      <tr><th>Leads</th><td>{{ lead_count }}</td></tr>
      <tr><th>Matriculaciones</th><td>{{ conversion_count }}</td></tr>
      <tr><th>Comisiones total</th><td>{{ '%.2f'|format(commission_sum) }}</td></tr>
      <tr><th>Pagadas</th><td>{{ '%.2f'|format(paid_sum) }}</td></tr>
      <tr><th>Pendientes</th><td>{{ '%.2f'|format(pending_sum) }}</td></tr>
    </tbody>
  </table>
</div>

<!-- Charts -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<div class="container pb-4">
  <div class="row g-4">
    <div class="col-12 col-lg-6">
      <canvas id="chartMoney"></canvas>
    </div>
    <div class="col-12 col-lg-6">
      <canvas id="chartLeads"></canvas>
    </div>
    <div class="col-12 col-lg-6">
      <canvas id="chartLeadStates"></canvas>
    </div>
    <div class="col-12 col-lg-6">
      <canvas id="chartLedgerStates"></canvas>
    </div>
  </div>
</div>
<script>
const monthLabels = {{ month_labels|tojson }};
const paidSeries = {{ paid_series|tojson }};
const pendingSeries = {{ pending_series|tojson }};
const leadSeries = {{ lead_series|tojson }};
const matSeries = {{ mat_series|tojson }};
const leadStateLabels = {{ lead_state_labels|tojson }};
const leadStateCounts = {{ lead_state_counts|tojson }};
const ledgerStateLabels = {{ ledger_state_labels|tojson }};
const ledgerStateCounts = {{ ledger_state_counts|tojson }};

new Chart(document.getElementById('chartMoney'), {
  type: 'line',
  data: {labels: monthLabels, datasets: [
    {label: 'Pagado', data: paidSeries, borderColor: 'green', backgroundColor:'rgba(0,128,0,0.2)', tension:.2},
    {label: 'Pendiente', data: pendingSeries, borderColor: 'orange', backgroundColor:'rgba(255,165,0,0.2)', tension:.2}
  ]},
  options: {responsive:true, plugins:{title:{display:true, text:'Monetizado por mes'}}}
});

new Chart(document.getElementById('chartLeads'), {
  type: 'line',
  data: {labels: monthLabels, datasets: [
    {label: 'Leads', data: leadSeries, borderColor: 'blue', backgroundColor:'rgba(0,0,255,0.2)', tension:.2},
    {label: 'Matriculados', data: matSeries, borderColor: 'purple', backgroundColor:'rgba(128,0,128,0.2)', tension:.2}
  ]},
  options: {responsive:true, plugins:{title:{display:true, text:'Leads vs Matriculados'}}}
});

new Chart(document.getElementById('chartLeadStates'), {
  type: 'bar',
  data: {labels: leadStateLabels, datasets: [{label:'Leads por estado', data: leadStateCounts, backgroundColor:'steelblue'}]},
  options: {responsive:true, plugins:{title:{display:true, text:'Estados de Leads'}}}
});

new Chart(document.getElementById('chartLedgerStates'), {
  type: 'bar',
  data: {labels: ledgerStateLabels, datasets: [{label:'Ledger por estado', data: ledgerStateCounts, backgroundColor:'teal'}]},
  options: {responsive:true, plugins:{title:{display:true, text:'Estados de Ledger'}}}
});
</script>
{% endblock %}
