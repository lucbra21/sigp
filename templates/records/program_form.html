{% extends 'layouts/base.html' %}
{% block title %}{{ 'Editar' if program else 'Nuevo' }} programa{% endblock %}
{% block content %}
<h2 class="fw-semibold mb-4 text-center">{{ 'Editar' if program else 'Nuevo' }} Programa</h2>
<div class="card shadow-sm border border-secondary-subtle bg-light mx-auto" style="max-width: 1000px;">
  <div class="card-body">
    
  <form id="programForm" method="post" enctype="multipart/form-data" class="row g-3">
  <div class="row">
    <div class="col-md-4 mb-3">
      <label class="form-label" for="name">Nombre</label>
      <input class="form-control" id="name" name="name" required value="{{ program.name if program else '' }}" />
    </div>
    <div class="col-md-4 mb-3">
      <label class="form-label" for="campus_id">Campus</label>
      <select class="form-select" id="campus_id" name="campus_id">
        <option value="">-- Seleccione --</option>
        {% set selected_campus = program.campus_id if program else '' %}
        {% for c in campuses %}
        <option value="{{ c.id }}" {{ 'selected' if selected_campus==c.id else '' }}>{{ c.name }}</option>
        {% endfor %}
      </select>
    </div>
  
    <div class="col-md-4 mb-3">
      <label class="form-label" for="language">Idioma</label>
      <select class="form-select" id="language" name="language">
        {% set lang = program.language if program else '' %}
        <option value="Español" {{ 'selected' if lang=='Español' else '' }}>Español</option>
        <option value="Inglés" {{ 'selected' if lang in ['Inglés','Ingles'] else '' }}>Inglés</option>
        <option value="Portugués" {{ 'selected' if lang in ['Portugués','Portugues'] else '' }}>Portugués</option>
      </select>
    </div>
  </div>
  <div class="mb-3">
    <label class="form-label" for="description">Descripción</label>
    <textarea class="form-control" id="description" name="description">{{ program.description if program else '' }}</textarea>
  </div>
  <div class="row">
    <div class="col-md-4 mb-3">
      <label class="form-label" for="price_total">Precio total</label>
      <input class="form-control" id="price_total" name="price_total" type="number" step="0.01" value="{{ program.price_total if program else '' }}" />
    </div>
    <div class="col-md-4 mb-3">
      <label class="form-label" for="price_scholarship">Precio becado (lo que el alumno paga)</label>
      <input class="form-control" id="price_scholarship" name="price_scholarship" type="number" step="0.01" value="{{ program.price_scholarship if program else '' }}" />
    </div>
    <div class="col-md-4 mb-3">
      <label class="form-label" for="commission_value">Comisión total</label>
      <input class="form-control" id="commission_value" name="commission_value" type="number" step="0.01" value="{{ program.commission_value if program else '' }}" />
    </div>
  </div>
  <div class="row">
    <div class="col-md-4 mb-3">
      <label class="form-label" for="first_installment_pct">Comisión - Porcentaje 1ª cuota</label>
      <input class="form-control" id="first_installment_pct" name="first_installment_pct" type="number" step="0.01" value="{{ program.first_installment_pct if program else '' }}" />
    </div>
    <div class="col-md-4 mb-3">
      <label class="form-label" for="pvp">PVP (Universidad)</label>
      <input class="form-control" id="pvp" name="pvp" type="number" step="0.01" value="{{ program.pvp if program else '' }}" />
    </div>
    <div class="col-md-4 mb-3">
      <label class="form-label" for="value_quotas">Comisión - Saldo en cuotas</label>
      <input class="form-control" id="value_quotas" name="value_quotas" type="number" step="0.01" value="{{ program.value_quotas if program else '' }}" />
    </div>
  </div>
  <div class="row">
    <div class="col-md-4 mb-3">
      <label class="form-label" for="scholarship_value">Valor beca</label>
      <input class="form-control" id="scholarship_value" name="scholarship_value" type="number" step="0.01" value="{{ program.scholarship_value if program else '' }}" />
    </div>
    <div class="col-md-4 mb-3">
      <label class="form-label" for="registration_value">Pre-Matrícula</label>
      <input class="form-control" id="registration_value" name="registration_value" type="number" step="0.01" value="{{ program.registration_value if program else '' }}" />
    </div>
    <div class="col-md-4 mb-3">
      <label class="form-label" for="level">Nivel</label>
      {% set lvl = program.level if program else '' %}
      <select class="form-select" id="level" name="level">
        {% for option in ['TITANIO','PLATINO','ORO','PLATA','BRONCE','BASE'] %}
        <option value="{{ option }}" {{ 'selected' if lvl==option else '' }}>{{ option }}</option>
        {% endfor %}
      </select>
    </div>
  </div>
  <div class="mb-3">
     <label class="form-label" for="commercial_emails">Emails comerciales (separados por coma)</label>
     <textarea class="form-control" id="commercial_emails" name="commercial_emails" rows="2" placeholder="email1@example.com, email2@example.com">{{ program.commercial_emails if program else '' }}</textarea>
   </div>
   <div class="row">
     <div class="col-md-6 mb-3">
       <label class="form-label" for="program_url">URL del programa</label>
       <input class="form-control" id="program_url" name="program_url" type="url" value="{{ program.program_url if program else '' }}" />
     </div>
     <div class="col-md-6 mb-3">
       <label class="form-label" for="program_file">PDF del programa</label>
       <input class="form-control" id="program_file" name="program_file" type="file" accept="application/pdf" />
       {% if program and program.program_file %}<a href="{{ program.program_file }}" target="_blank" class="small">Ver actual</a>{% endif %}
     </div>
   </div>
   <div class="row">
     <div class="col-md-6 mb-3">
       <label class="form-label" for="image_small">Imagen pequeña</label>
       <input class="form-control" id="image_small" name="image_small" type="file" accept="image/*" />
       {% if program and program.image_small %}<img src="{{ program.image_small }}" alt="img small" class="img-thumbnail mt-1" style="max-width:120px">{% endif %}
     </div>
     <div class="col-md-6 mb-3">
       <label class="form-label" for="image_large">Imagen grande</label>
       <input class="form-control" id="image_large" name="image_large" type="file" accept="image/*" />
       {% if program and program.image_large %}<img src="{{ program.image_large }}" alt="img large" class="img-thumbnail mt-1" style="max-width:120px">{% endif %}
     </div>
   </div>
  <div class="mb-3">
    <label class="form-label" for="state">Estado</label>
    {% set st = program.state if program else 'Activo' %}
    <select class="form-select" id="state" name="state">
      <option value="Activo" {{ 'selected' if st=='Activo' else '' }}>Activo</option>
      <option value="Desactivado" {{ 'selected' if st=='Desactivado' else '' }}>Desactivado</option>
    </select>
  </div>
  
      <div class="col-12 text-center pt-3">
        <button type="submit" class="btn btn-primary me-2">Guardar</button>
        <a href="{{ url_for('programs.programs_list') }}" class="btn btn-secondary" id="cancelProgram">Cancelar</a>
      </div>
    </form>
  </div>
</div>
<!-- Loading overlay -->
<div id="programFormLoading" class="position-fixed top-0 start-0 w-100 h-100 d-none justify-content-center align-items-center" style="background:rgba(255,255,255,.7);z-index:1050;">
  <img src="{{ url_for('static', filename='img/loader.gif') }}" alt="cargando...">
</div>
<script>
  document.addEventListener('DOMContentLoaded', function(){
    const form = document.getElementById('programForm');
    const overlay = document.getElementById('programFormLoading');
    if(form){
      form.addEventListener('submit', function(){
        if(form.checkValidity()){
          overlay.classList.remove('d-none');
          overlay.classList.add('d-flex');
        }
      });
    }
    const cancelBtn = document.getElementById('cancelProgram');
    if(cancelBtn){
      cancelBtn.addEventListener('click', function(){
        overlay.classList.remove('d-none');
        overlay.classList.add('d-flex');
      });
    }
  });
</script>
{% endblock %}
