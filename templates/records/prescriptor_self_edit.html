{% extends 'layouts/base.html' %}
{% block title %}Actualizar mis datos{% endblock %}
{% block content %}
<h2 class="fw-semibold mb-4 text-center">Actualizar mis datos</h2>
<div class="card shadow-sm border border-secondary-subtle bg-light mx-auto" style="max-width:800px;">
  <div class="card-body">
<form id="selfEditForm" method="POST" enctype="multipart/form-data" action="{{ url_for('prescriptors.edit_my_prescriptor') }}" class="row g-3">
  {{ form.csrf_token }}
  {{ form.hidden_tag() }}
  {% if form.squeeze_page_image_1_file is defined %}
  <div class="col-md-12">
    <label for="squeezeImg" class="form-label">Foto Squeeze Page</label>
    <div class="text-center mb-2">
      <img src="{{ photo_url }}" id="previewImg" class="img-thumbnail" style="max-width:120px" {% if not photo_url %}class="d-none"{% endif %}>
    </div>
    {{ form.squeeze_page_image_1_file(id='squeezeImg', class='form-control') }}
  </div>
  {% endif %}
  <div class="col-md-6">
    {{ form.face_url.label(class='form-label') }}
    {{ form.face_url(class='form-control') }}
  </div>
  <div class="col-md-6">
    {{ form.linkedin_url.label(class='form-label') }}
    {{ form.linkedin_url(class='form-control') }}
  </div>
  <div class="col-md-6">
    {{ form.instagram_url.label(class='form-label') }}
    {{ form.instagram_url(class='form-control') }}
  </div>
  <div class="col-md-6">
    {{ form.x_url.label(class='form-label') }}
    {{ form.x_url(class='form-control') }}
  </div>
  <div class="col-md-12">
    {{ form.observations.label(class='form-label') }}
    {{ form.observations(class='form-control', rows=3) }}
  </div>
  <div class="col-md-12">
    <hr>
    <h5 class="mb-2">Contrato</h5>
    {% if current_prescriptor %}
      <button type="submit"
              id="btnGenerateContract"
              class="btn btn-outline-primary"
              formaction="{{ url_for('contracts.generate_for_prescriptor', prescriptor_id=current_prescriptor.id) }}"
              formmethod="post" formnovalidate>
        <i class="bi bi-envelope-paper"></i> Generar / Reenviar link de firma
      </button>
    {% endif %}
    {% if presc_contract_url %}
      <a class="btn btn-outline-secondary ms-2" href="{{ presc_contract_url }}" target="_blank">
        <i class="bi bi-file-earmark-pdf"></i> Ver contrato actual
      </a>
    {% endif %}
  </div>
  <div class="col-12 text-end">
    <button type="submit" class="btn btn-primary"><i class="bi bi-save"></i> Guardar cambios</button>
    <a href="{{ url_for('index') }}" class="btn btn-secondary">Cancelar</a>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded',()=>{
      const f=document.getElementById('selfEditForm');
      const btn=document.getElementById('btnGenerateContract');
      const overlay=document.getElementById('globalLoading');
      const showOverlay=()=>{ if(overlay){ overlay.classList.remove('d-none'); overlay.classList.add('d-flex'); } };
      if(f){ f.addEventListener('submit',showOverlay); }
      if(btn){ btn.addEventListener('click',()=>{ showOverlay(); }); }
    });
        const input=document.getElementById('squeezeImg');
      const preview=document.getElementById('previewImg');
      if(input && preview){
        input.addEventListener('change',e=>{
          const file=e.target.files[0];
          if(file){
            preview.src=URL.createObjectURL(file);
            preview.classList.remove('d-none');
          }
        });
      }
    </script>
  </div>
</div>
{% endblock %}
