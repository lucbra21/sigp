{% extends 'layouts/base.html' %}
{% block content %}
<div class="container py-4">
  <div class="row g-4">
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <h5 class="mb-3">Firma del Presidente</h5>
          <p>Dibujá tu firma en el recuadro y confirmá para aplicarla al contrato y firmarlo digitalmente.</p>
          <div class="border rounded p-2 mb-3 bg-light">
            <canvas id="sigpad" style="width:100%;height:220px;border:1px dashed #999;background:#fff;"></canvas>
          </div>
          <div class="d-flex gap-2 mb-3">
            <button class="btn btn-secondary" id="btn-clear" type="button">Limpiar</button>
          </div>
          <form method="post" action="{{ url_for('contracts.sign_president_post') }}" onsubmit="return submitSignature();">
            <input type="hidden" name="token" value="{{ token }}">
            <input type="hidden" name="signature_data" id="signature_data">
            <button class="btn btn-primary" type="submit">Firmar ahora</button>
          </form>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card h-100">
        <div class="card-body">
          <h6 class="mb-2">Vista previa del contrato</h6>
          {% if prescriptor and prescriptor.contract_url %}
          <div class="ratio ratio-1x1" style="min-height:420px;">
            <iframe src="{{ prescriptor.contract_url }}#view=fitH" title="Contrato" style="width:100%;height:100%;border:1px solid #ddd;border-radius:6px;"></iframe>
          </div>
          <div class="mt-2">
            <a class="btn btn-sm btn-outline-secondary" target="_blank" href="{{ prescriptor.contract_url }}">Abrir en nueva pestaña</a>
          </div>
          {% else %}
          <div class="alert alert-warning mb-0">No se encontró el PDF del contrato para previsualizar.</div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>
<script>
(function(){
  const canvas = document.getElementById('sigpad');
  function resizeCanvas(){
    const ratio = Math.max(window.devicePixelRatio || 1, 1);
    const rect = canvas.getBoundingClientRect();
    canvas.width = rect.width * ratio;
    canvas.height = 220 * ratio;
    const ctx = canvas.getContext('2d');
    ctx.scale(ratio, ratio);
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  const pad = new SignaturePad(canvas, {backgroundColor: 'rgb(255,255,255)'});
  document.getElementById('btn-clear').addEventListener('click', function(){ pad.clear(); });

  window.submitSignature = function(){
    if (pad.isEmpty()) { alert('Por favor dibujá tu firma.'); return false; }
    const dataUrl = pad.toDataURL('image/png');
    document.getElementById('signature_data').value = dataUrl;
    const overlay = document.getElementById('globalLoading');
    if (overlay){ overlay.classList.remove('d-none'); overlay.classList.add('d-flex'); }
    return true;
  }
})();
</script>
{% endblock %}
